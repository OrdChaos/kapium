{
  "abbrlink": "fd9dafa1",
  "category": "编程",
  "content": "<p>时隔一年，终于抽出来时间完全重写了AI摘要的后端。</p>\n<!--more-->\n<h2 id=\"ec798f51\">起因</h2>\n<p>TianliGPT的文章摘要很好用，但是本来会能够根据content保证摘要不重复生成，现在不行了，不知道为什么。（我知道现在改为用url鉴别了，但是我的js最开始我就自己改过了，没有更新）</p>\n<p>于是每刷新一次摘要就重新生成一次，token余额哗哗掉。</p>\n<p>想着与其重新改一遍js，不如全权改为自己的版本，于是就有了这个项目。</p>\n<p>现在本文（以及其它文章）开头的摘要就是来自OrdChaosGPT的了。</p>\n<h2 id=\"5a855f2a\">介绍</h2>\n<p>大概是TianliGPT的下位代替品</p>\n<p>使用阿里云通义千问（qwen-long）作为摘要生成引擎，Vercel部署，MySQL数据库持久化数据储存</p>\n<p>优势是无服务器（？真的是优势吗）</p>\n<p>缺点是稳定性（至少我不提供SLA保证）与速度（依据文章长度与网速，获取到摘要的时间平均约10秒）</p>\n<p>仓库地址：<a href=\"https://github.com/OrdChaos/ordchaosgpt-cloud-function\">ordchaosgpt-cloud-function</a></p>\n<h2 id=\"7e944277\">经历</h2>\n<p>最开始还是想着用rust写一个服务端跑在docker上。</p>\n<p>服务端倒是好写：</p>\n<div class=\"code-block-wrapper\">\n          <div class=\"code-block-header\">\n            <span class=\"code-lang\">RUST</span>\n            <div class=\"copy-card\" onclick=\"window.copyToClipboard(this)\">Copy</div>\n          </div>\n          <pre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\" data-line=\"1\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">use</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> actix_web</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">::</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">{post, web, </span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">App</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">, </span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">HttpServer</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">, </span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">Responder</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">, </span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">HttpResponse</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">, </span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">HttpRequest</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">};</span></span>\n<span class=\"line\" data-line=\"2\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">use</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> serde</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">::</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">{</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">Deserialize</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">, </span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">Serialize</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">};</span></span>\n<span class=\"line\" data-line=\"3\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">use</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> std</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">::</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">path</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">::</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">Path</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">;</span></span>\n<span class=\"line\" data-line=\"4\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">use</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> std</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">::</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">fs;</span></span>\n<span class=\"line\" data-line=\"5\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">use</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> reqwest</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">::</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">Client</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">;</span></span>\n<span class=\"line\" data-line=\"6\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">use</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> serde_json</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">::</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">json;</span></span>\n<span class=\"line\" data-line=\"7\" class=\"line\"></span>\n<span class=\"line\" data-line=\"8\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">#[derive(</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">Serialize</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">, </span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">Deserialize</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">)]</span></span>\n<span class=\"line\" data-line=\"9\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">struct</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> SummaryRequest</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> {</span></span>\n<span class=\"line\" data-line=\"10\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    content</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">:</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> String</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">,</span></span>\n<span class=\"line\" data-line=\"11\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    url</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">:</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> String</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">,</span></span>\n<span class=\"line\" data-line=\"12\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">}</span></span>\n<span class=\"line\" data-line=\"13\" class=\"line\"></span>\n<span class=\"line\" data-line=\"14\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">#[derive(</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">Serialize</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">, </span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">Deserialize</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">)]</span></span>\n<span class=\"line\" data-line=\"15\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">struct</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> SummaryResponse</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> {</span></span>\n<span class=\"line\" data-line=\"16\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    url</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">:</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> String</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">,</span></span>\n<span class=\"line\" data-line=\"17\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    summary</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">:</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> String</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">,</span></span>\n<span class=\"line\" data-line=\"18\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">}</span></span>\n<span class=\"line\" data-line=\"19\" class=\"line\"></span>\n<span class=\"line\" data-line=\"20\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">struct</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> AppState</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> {</span></span>\n<span class=\"line\" data-line=\"21\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    auth_token</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">:</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> String</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">,</span></span>\n<span class=\"line\" data-line=\"22\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">}</span></span>\n<span class=\"line\" data-line=\"23\" class=\"line\"></span>\n<span class=\"line\" data-line=\"24\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">const</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> SUMMARY_DIR</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">:</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> &#x26;</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">str</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> =</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \"summaries\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">;</span></span>\n<span class=\"line\" data-line=\"25\" class=\"line\"></span>\n<span class=\"line\" data-line=\"26\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">fn</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> is_valid_referer</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(referer</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">:</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> Option</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">&#x3C;</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">&#x26;</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">str</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">>) </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">-></span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> bool</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> {</span></span>\n<span class=\"line\" data-line=\"27\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    if</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> let</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> Some</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(ref_url) </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> referer {</span></span>\n<span class=\"line\" data-line=\"28\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">        let</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> valid_domains </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> vec!</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">[</span></span>\n<span class=\"line\" data-line=\"29\" class=\"line\"><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">            \".ordchaos.com\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">,</span></span>\n<span class=\"line\" data-line=\"30\" class=\"line\"><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">            \".ordchaos.top\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">,</span></span>\n<span class=\"line\" data-line=\"31\" class=\"line\"><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">            \".ordchaos.eu.org\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">,</span></span>\n<span class=\"line\" data-line=\"32\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">        ];</span></span>\n<span class=\"line\" data-line=\"33\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">        return</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> valid_domains</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">iter</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">()</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">any</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">|</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">domain</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">|</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> ref_url</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">ends_with</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(domain));</span></span>\n<span class=\"line\" data-line=\"34\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    }</span></span>\n<span class=\"line\" data-line=\"35\" class=\"line\"><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">    false</span></span>\n<span class=\"line\" data-line=\"36\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">}</span></span>\n<span class=\"line\" data-line=\"37\" class=\"line\"></span>\n<span class=\"line\" data-line=\"38\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">async</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> fn</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> generate_summary</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(content</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">:</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> &#x26;</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">str</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">) </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">-></span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> Result</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">&#x3C;</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">String</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">, </span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">Box</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">&#x3C;</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">dyn</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> std</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">::</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">error</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">::</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">Error</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">>> {</span></span>\n<span class=\"line\" data-line=\"39\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    let</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> api_key </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \"*******************************\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">;</span></span>\n<span class=\"line\" data-line=\"40\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    let</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> api_url </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \"https://dashscope.aliyuncs.com/compatible-mode/v1\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">;</span></span>\n<span class=\"line\" data-line=\"41\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    let</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> client </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> Client</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">::</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">new</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">();</span></span>\n<span class=\"line\" data-line=\"42\" class=\"line\"></span>\n<span class=\"line\" data-line=\"43\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    let</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> request_body </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> json!</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">({</span></span>\n<span class=\"line\" data-line=\"44\" class=\"line\"><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">        \"model\"</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">:</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \"qwen-long\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">,</span></span>\n<span class=\"line\" data-line=\"45\" class=\"line\"><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">        \"messages\"</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">:</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> [</span></span>\n<span class=\"line\" data-line=\"46\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">            {</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"role\"</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">:</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \"system\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">, </span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"content\"</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">:</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \"You are a helpful summary generator.\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">},</span></span>\n<span class=\"line\" data-line=\"47\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">            {</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"role\"</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">:</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \"user\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">, </span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"content\"</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">:</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> format!</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"请为以下内容用中文生成长度为150汉字左右的摘要，摘要只有一个自然段，且只给出摘要即可，不要说其他任何话: {}\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">, content)}</span></span>\n<span class=\"line\" data-line=\"48\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">        ],</span></span>\n<span class=\"line\" data-line=\"49\" class=\"line\"><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">        \"temperature\"</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">:</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> 0.8</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">,</span></span>\n<span class=\"line\" data-line=\"50\" class=\"line\"><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">        \"top_p\"</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">:</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> 0.8</span></span>\n<span class=\"line\" data-line=\"51\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    });</span></span>\n<span class=\"line\" data-line=\"52\" class=\"line\"></span>\n<span class=\"line\" data-line=\"53\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    let</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> response </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> client</span></span>\n<span class=\"line\" data-line=\"54\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">        .</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">post</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">format!</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"{}/chat/completions\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">, api_url))</span></span>\n<span class=\"line\" data-line=\"55\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">        .</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">header</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"Authorization\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">, </span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">format!</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"Bearer {}\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">, api_key))</span></span>\n<span class=\"line\" data-line=\"56\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">        .</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">json</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">&#x26;</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">request_body)</span></span>\n<span class=\"line\" data-line=\"57\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">        .</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">send</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">()</span></span>\n<span class=\"line\" data-line=\"58\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">        .await?</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">;</span></span>\n<span class=\"line\" data-line=\"59\" class=\"line\"></span>\n<span class=\"line\" data-line=\"60\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    let</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> response_json</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">:</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> serde_json</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">::</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">Value</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> =</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> response</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">json</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">()</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">.await?</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">;</span></span>\n<span class=\"line\" data-line=\"61\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    let</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> summary </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> response_json[</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"choices\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">][</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">0</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">][</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"message\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">][</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"content\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">]</span></span>\n<span class=\"line\" data-line=\"62\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">        .</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">as_str</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">()</span></span>\n<span class=\"line\" data-line=\"63\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">        .</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">unwrap_or</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"摘要生成失败：返回格式不正确\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">)</span></span>\n<span class=\"line\" data-line=\"64\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">        .</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">to_string</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">();</span></span>\n<span class=\"line\" data-line=\"65\" class=\"line\"></span>\n<span class=\"line\" data-line=\"66\" class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">    Ok</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(summary</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">trim</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">()</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">to_string</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">())</span></span>\n<span class=\"line\" data-line=\"67\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">}</span></span>\n<span class=\"line\" data-line=\"68\" class=\"line\"></span>\n<span class=\"line\" data-line=\"69\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">fn</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> save_summary</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(abbrlink</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">:</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> &#x26;</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">str</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">, summary_data</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">:</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> &#x26;</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">SummaryResponse</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">) </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">-></span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> std</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">::</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">io</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">::</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">Result</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">&#x3C;()> {</span></span>\n<span class=\"line\" data-line=\"70\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    let</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> summary_path </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> format!</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"{}/{}.json\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">, </span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">SUMMARY_DIR</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">, abbrlink);</span></span>\n<span class=\"line\" data-line=\"71\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    let</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> json_data </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> serde_json</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">::</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">to_string</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(summary_data)</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">?</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">;</span></span>\n<span class=\"line\" data-line=\"72\" class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">    fs</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">::</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">write</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">&#x26;</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">summary_path, </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">&#x26;</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">json_data)</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">?</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">;</span></span>\n<span class=\"line\" data-line=\"73\" class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">    Ok</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(())</span></span>\n<span class=\"line\" data-line=\"74\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">}</span></span>\n<span class=\"line\" data-line=\"75\" class=\"line\"></span>\n<span class=\"line\" data-line=\"76\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">fn</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> load_summary</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(abbrlink</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">:</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> &#x26;</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">str</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">) </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">-></span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> Option</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">&#x3C;</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">SummaryResponse</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">> {</span></span>\n<span class=\"line\" data-line=\"77\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    let</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> summary_path </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> format!</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"{}/{}.json\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">, </span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">SUMMARY_DIR</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">, abbrlink);</span></span>\n<span class=\"line\" data-line=\"78\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    if</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> Path</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">::</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">new</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">&#x26;</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">summary_path)</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">exists</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">() {</span></span>\n<span class=\"line\" data-line=\"79\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">        if</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> let</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> Ok</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(json_data) </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> fs</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">::</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">read_to_string</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">&#x26;</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">summary_path) {</span></span>\n<span class=\"line\" data-line=\"80\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">            if</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> let</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> Ok</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(summary) </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> serde_json</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">::</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">from_str</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">&#x26;</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">json_data) {</span></span>\n<span class=\"line\" data-line=\"81\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">                return</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> Some</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(summary);</span></span>\n<span class=\"line\" data-line=\"82\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">            }</span></span>\n<span class=\"line\" data-line=\"83\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">        }</span></span>\n<span class=\"line\" data-line=\"84\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    }</span></span>\n<span class=\"line\" data-line=\"85\" class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">    None</span></span>\n<span class=\"line\" data-line=\"86\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">}</span></span>\n<span class=\"line\" data-line=\"87\" class=\"line\"></span>\n<span class=\"line\" data-line=\"88\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">#[post(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"/generate-summary\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">)]</span></span>\n<span class=\"line\" data-line=\"89\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">async</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> fn</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> generate_summary_handler</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span></span>\n<span class=\"line\" data-line=\"90\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    data</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">:</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> web</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">::</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">Data</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">&#x3C;</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">AppState</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">>,</span></span>\n<span class=\"line\" data-line=\"91\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    req</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">:</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> HttpRequest</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">,</span></span>\n<span class=\"line\" data-line=\"92\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    summary_request</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">:</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> web</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">::</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">Json</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">&#x3C;</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">SummaryRequest</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">></span></span>\n<span class=\"line\" data-line=\"93\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">) </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">-></span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> impl</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> Responder</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> {</span></span>\n<span class=\"line\" data-line=\"94\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    if</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> let</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> Some</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(auth_header) </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> req</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">headers</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">()</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">get</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"Authorization\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">) {</span></span>\n<span class=\"line\" data-line=\"95\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">        let</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> token </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> auth_header</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">to_str</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">()</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">unwrap_or</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">)</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">trim_start_matches</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"Bearer \"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">);</span></span>\n<span class=\"line\" data-line=\"96\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">        if</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> token </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">!=</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> data</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">.</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">auth_token {</span></span>\n<span class=\"line\" data-line=\"97\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">            return</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> HttpResponse</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">::</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">Unauthorized</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">()</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">body</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"鉴权失败：Token不正确\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">);</span></span>\n<span class=\"line\" data-line=\"98\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">        }</span></span>\n<span class=\"line\" data-line=\"99\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    } </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">else</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> {</span></span>\n<span class=\"line\" data-line=\"100\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">        return</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> HttpResponse</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">::</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">Unauthorized</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">()</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">body</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"鉴权失败：缺失Token\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">);</span></span>\n<span class=\"line\" data-line=\"101\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    }</span></span>\n<span class=\"line\" data-line=\"102\" class=\"line\"></span>\n<span class=\"line\" data-line=\"103\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    let</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> referer </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> req</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">headers</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">()</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">get</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"Referer\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">)</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">and_then</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">|</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">v</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">|</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> v</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">to_str</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">()</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">ok</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">());</span></span>\n<span class=\"line\" data-line=\"104\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    let</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> origin </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> req</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">headers</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">()</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">get</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"Origin\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">)</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">and_then</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">|</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">v</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">|</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> v</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">to_str</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">()</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">ok</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">());</span></span>\n<span class=\"line\" data-line=\"105\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    if</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> !</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">is_valid_referer</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(referer) </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">&#x26;&#x26;</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> !</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">is_valid_referer</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(origin) {</span></span>\n<span class=\"line\" data-line=\"106\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">        return</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> HttpResponse</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">::</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">Forbidden</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">()</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">body</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"拒绝生成摘要：来源不正确\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">);</span></span>\n<span class=\"line\" data-line=\"107\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    }</span></span>\n<span class=\"line\" data-line=\"108\" class=\"line\"></span>\n<span class=\"line\" data-line=\"109\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    let</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> abbrlink </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> summary_request</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">.</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">url</span></span>\n<span class=\"line\" data-line=\"110\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">        .</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">split</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">'/'</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">)</span></span>\n<span class=\"line\" data-line=\"111\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">        .</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">filter</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">|&#x26;</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">segment</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">|</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> !</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">segment</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">is_empty</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">())</span></span>\n<span class=\"line\" data-line=\"112\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">        .</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">last</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">()</span></span>\n<span class=\"line\" data-line=\"113\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">        .</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">unwrap_or</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">);</span></span>\n<span class=\"line\" data-line=\"114\" class=\"line\"></span>\n<span class=\"line\" data-line=\"115\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    if</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> abbrlink</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">is_empty</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">() {</span></span>\n<span class=\"line\" data-line=\"116\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">        return</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> HttpResponse</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">::</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">BadRequest</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">()</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">body</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"Invalid URL format\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">);</span></span>\n<span class=\"line\" data-line=\"117\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    }</span></span>\n<span class=\"line\" data-line=\"118\" class=\"line\"></span>\n<span class=\"line\" data-line=\"119\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    if</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> let</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> Some</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(existing_summary) </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> load_summary</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(abbrlink) {</span></span>\n<span class=\"line\" data-line=\"120\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">        return</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> HttpResponse</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">::</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">Ok</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">()</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">json</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(existing_summary);</span></span>\n<span class=\"line\" data-line=\"121\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    }</span></span>\n<span class=\"line\" data-line=\"122\" class=\"line\"></span>\n<span class=\"line\" data-line=\"123\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    let</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> summary </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> match</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> generate_summary</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">&#x26;</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">summary_request</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">.</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">content)</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">.await</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> {</span></span>\n<span class=\"line\" data-line=\"124\" class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">        Ok</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(summary) </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=></span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> summary,</span></span>\n<span class=\"line\" data-line=\"125\" class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">        Err</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(_) </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=></span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> return</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> HttpResponse</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">::</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">InternalServerError</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">()</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">body</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"摘要生成失败\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">),</span></span>\n<span class=\"line\" data-line=\"126\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    };</span></span>\n<span class=\"line\" data-line=\"127\" class=\"line\"></span>\n<span class=\"line\" data-line=\"128\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    let</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> summary_data </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> SummaryResponse</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> {</span></span>\n<span class=\"line\" data-line=\"129\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">        url</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">:</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> summary_request</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">.</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">url</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">clone</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(),</span></span>\n<span class=\"line\" data-line=\"130\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">        summary</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">:</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> summary</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">clone</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(),</span></span>\n<span class=\"line\" data-line=\"131\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    };</span></span>\n<span class=\"line\" data-line=\"132\" class=\"line\"></span>\n<span class=\"line\" data-line=\"133\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    if</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> let</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> Err</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(err) </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> save_summary</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(abbrlink, </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">&#x26;</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">summary_data) {</span></span>\n<span class=\"line\" data-line=\"134\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">        return</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> HttpResponse</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">::</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">InternalServerError</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">()</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">body</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">format!</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"存储摘要失败： {}\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">, err));</span></span>\n<span class=\"line\" data-line=\"135\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    }</span></span>\n<span class=\"line\" data-line=\"136\" class=\"line\"></span>\n<span class=\"line\" data-line=\"137\" class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">    HttpResponse</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">::</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">Ok</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">()</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">json</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(summary_data)</span></span>\n<span class=\"line\" data-line=\"138\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">}</span></span>\n<span class=\"line\" data-line=\"139\" class=\"line\"></span>\n<span class=\"line\" data-line=\"140\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">#[actix_web</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">::</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">main]</span></span>\n<span class=\"line\" data-line=\"141\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">async</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> fn</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> main</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">() </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">-></span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> std</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">::</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">io</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">::</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">Result</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">&#x3C;()> {</span></span>\n<span class=\"line\" data-line=\"142\" class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">    fs</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">::</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">create_dir_all</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">SUMMARY_DIR</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">)</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">?</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">;</span></span>\n<span class=\"line\" data-line=\"143\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    let</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> auth_token </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> std</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">::</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">env</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">::</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">var</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"AUTH_TOKEN\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">)</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">expect</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"AUTH_TOKEN 未被设置\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">);</span></span>\n<span class=\"line\" data-line=\"144\" class=\"line\"></span>\n<span class=\"line\" data-line=\"145\" class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">    println!</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"服务端已经在 http://localhost:11451 开启\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">);</span></span>\n<span class=\"line\" data-line=\"146\" class=\"line\"></span>\n<span class=\"line\" data-line=\"147\" class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">    HttpServer</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">::</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">new</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">move</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> ||</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> {</span></span>\n<span class=\"line\" data-line=\"148\" class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">        App</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">::</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">new</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">()</span></span>\n<span class=\"line\" data-line=\"149\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">            .</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">app_data</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">web</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">::</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">Data</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">::</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">new</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">AppState</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> {</span></span>\n<span class=\"line\" data-line=\"150\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">                auth_token</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">:</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> auth_token</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">clone</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(),</span></span>\n<span class=\"line\" data-line=\"151\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">            }))</span></span>\n<span class=\"line\" data-line=\"152\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">            .</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">service</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(generate_summary_handler)</span></span>\n<span class=\"line\" data-line=\"153\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    })</span></span>\n<span class=\"line\" data-line=\"154\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    .</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">bind</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"127.0.0.1:11451\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">)</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">?</span></span>\n<span class=\"line\" data-line=\"155\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    .</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">run</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">()</span></span>\n<span class=\"line\" data-line=\"156\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    .await</span></span>\n<span class=\"line\" data-line=\"157\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">}</span></span>\n<span class=\"line\" data-line=\"158\" class=\"line\"></span></code></pre>\n        </div>\n<p>（有兴趣就拿去用吧，标识原作者就好）</p>\n<p>结果部署docker的时候服务器炸了，原因未知。</p>\n<p>所以想着还是别再折腾我那辣鸡服务器了，遂转为用JavaScript写云函数，主打一个Serverless.</p>\n<p>没什么好说的，主要是第一次写不太熟练，本身还是挺简单的。</p>\n<p>遇到的问题是MongoDB没连上，无奈改为MySQL<span class=\"heimu\" title=\"你知道的太多了\">结果用的还是服务器上的数据库</span>。</p>\n<h2 id=\"caa3b19f\">部署</h2>\n<p>如果你想使用的话，前往<a href=\"https://github.com/OrdChaos/ordchaosgpt-cloud-function\">这个项目的仓库</a>参考<code>readme.md</code>即可。</p>\n<p>部署非常简单，有手就行，要求自备MySQL数据库。</p>\n<h2 id=\"f23d890d\">题外话</h2>\n<p>写了一上午的JS（</p>\n<p>那就这样，886</p>\n",
  "date": "2024-08-14 17:08:50",
  "excerpt": "时隔一年，终于抽出来时间完全重写了AI摘要的后端。",
  "index_img": "https://img.ordchaos.com/img/2024/08/b118d0f8b8105792e571ae40c8b7abb4.png",
  "readTime": "10",
  "summary": "这篇博文介绍了博主时隔一年后完全重写AI摘要后端的经历，起因是TianliGPT的摘要重复生成问题导致token消耗过快，于是博主开发了基于阿里云通义千问（qwen-long）、部署于Vercel并使用MySQL持久化存储的替代方案OrdChaosGPT，虽存在稳定性和速度上的不足，但已用于本站文章摘要生成，并分享了项目经历与技术实现细节。",
  "tags": [
    "javascript",
    "npm",
    "vercel",
    "无服务器",
    "AI",
    "计算机",
    "编程",
    "教程"
  ],
  "title": "无服务器AI摘要后端——OrdChaosGPT",
  "toc": [
    {
      "id": "ec798f51",
      "level": 2,
      "text": "起因"
    },
    {
      "id": "5a855f2a",
      "level": 2,
      "text": "介绍"
    },
    {
      "id": "7e944277",
      "level": 2,
      "text": "经历"
    },
    {
      "id": "caa3b19f",
      "level": 2,
      "text": "部署"
    },
    {
      "id": "f23d890d",
      "level": 2,
      "text": "题外话"
    }
  ],
  "updated": "2024-08-14 17:08:50"
}