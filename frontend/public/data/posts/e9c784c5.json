{
  "abbrlink": "e9c784c5",
  "category": "教程",
  "content": "<p>主要是邮件服务器的容器经常崩溃，所以尝试设置定时任务来解决这个问题。</p>\n<!--more-->\n<h2 id=\"1afcb3cc\">情景引入</h2>\n<p>邮件服务器性能羸弱，无法胜任设置定时任务这样的重担，所以只能用一些盘外招试试了。</p>\n<p>有关于邮件服务器搭建，参考这篇文章：<a href=\"https://www.ordchaos.com/posts/3b90dbec/\">自托管 E-mail ，宝宝喜欢妈妈爱</a></p>\n<h2 id=\"dc64ae4b\">设置 Action</h2>\n<p>那么首先，本着轻量化的原则，新建一个仓库拿来干这种事：</p>\n<p><img loading=\"lazy\" src=\"https://img.ordchaos.com/img/2024/02/5e1a07ea1593440507e3e0bdb6c80c3b.png\" alt=\"\"></p>\n<p><img loading=\"lazy\" src=\"https://img.ordchaos.com/img/2024/02/9eb9df8cc12a4331e3cb95ccc902c52a.png\" alt=\"\"></p>\n<p>然后切到Action页面：</p>\n<p><img loading=\"lazy\" src=\"https://img.ordchaos.com/img/2024/02/a94c8d5c7c4026bb49bda5a0fc93e9d3.png\" alt=\"\"></p>\n<p>选择新建一个空白模板：</p>\n<p><img loading=\"lazy\" src=\"https://img.ordchaos.com/img/2024/02/235b3a988d6ae333547c22e3bf7cdcc1.png\" alt=\"\"></p>\n<p><img loading=\"lazy\" src=\"https://img.ordchaos.com/img/2024/02/d3bc49ec763c91aa05cf79e84e4006b8.png\" alt=\"\"></p>\n<p>修改Action名称、内容并设置定时，参考我的：</p>\n<div class=\"code-block-wrapper\">\n          <div class=\"code-block-header\">\n            <span class=\"code-lang\">YAML</span>\n            <div class=\"copy-card\" onclick=\"window.copyToClipboard(this)\">Copy</div>\n          </div>\n          <pre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\" data-line=\"1\" class=\"line\"><span style=\"color:#6A737D;--shiki-dark:#6A737D\"># This is a basic workflow to help you get started with Actions</span></span>\n<span class=\"line\" data-line=\"2\" class=\"line\"></span>\n<span class=\"line\" data-line=\"3\" class=\"line\"><span style=\"color:#22863A;--shiki-dark:#85E89D\">name</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">: </span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">REMX</span></span>\n<span class=\"line\" data-line=\"4\" class=\"line\"></span>\n<span class=\"line\" data-line=\"5\" class=\"line\"><span style=\"color:#6A737D;--shiki-dark:#6A737D\"># Controls when the workflow will run</span></span>\n<span class=\"line\" data-line=\"6\" class=\"line\"><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">on</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">:</span></span>\n<span class=\"line\" data-line=\"7\" class=\"line\"><span style=\"color:#6A737D;--shiki-dark:#6A737D\">  # Triggers the workflow on push or pull request events but only for the \"main\" branch</span></span>\n<span class=\"line\" data-line=\"8\" class=\"line\"><span style=\"color:#22863A;--shiki-dark:#85E89D\">  push</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">:</span></span>\n<span class=\"line\" data-line=\"9\" class=\"line\"><span style=\"color:#22863A;--shiki-dark:#85E89D\">    branches</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">: [ </span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"main\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> ]</span></span>\n<span class=\"line\" data-line=\"10\" class=\"line\"><span style=\"color:#22863A;--shiki-dark:#85E89D\">  schedule</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">:</span></span>\n<span class=\"line\" data-line=\"11\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    - </span><span style=\"color:#22863A;--shiki-dark:#85E89D\">cron</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">: </span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"0 20 * * *\"</span></span>\n<span class=\"line\" data-line=\"12\" class=\"line\"></span>\n<span class=\"line\" data-line=\"13\" class=\"line\"><span style=\"color:#6A737D;--shiki-dark:#6A737D\">  # Allows you to run this workflow manually from the Actions tab</span></span>\n<span class=\"line\" data-line=\"14\" class=\"line\"><span style=\"color:#22863A;--shiki-dark:#85E89D\">  workflow_dispatch</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">:</span></span>\n<span class=\"line\" data-line=\"15\" class=\"line\"></span>\n<span class=\"line\" data-line=\"16\" class=\"line\"><span style=\"color:#6A737D;--shiki-dark:#6A737D\"># A workflow run is made up of one or more jobs that can run sequentially or in parallel</span></span>\n<span class=\"line\" data-line=\"17\" class=\"line\"><span style=\"color:#22863A;--shiki-dark:#85E89D\">jobs</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">:</span></span>\n<span class=\"line\" data-line=\"18\" class=\"line\"><span style=\"color:#6A737D;--shiki-dark:#6A737D\">  # This workflow contains a single job called \"build\"</span></span>\n<span class=\"line\" data-line=\"19\" class=\"line\"><span style=\"color:#22863A;--shiki-dark:#85E89D\">  build</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">:</span></span>\n<span class=\"line\" data-line=\"20\" class=\"line\"><span style=\"color:#6A737D;--shiki-dark:#6A737D\">    # The type of runner that the job will run on</span></span>\n<span class=\"line\" data-line=\"21\" class=\"line\"><span style=\"color:#22863A;--shiki-dark:#85E89D\">    runs-on</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">: </span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">ubuntu-latest</span></span>\n<span class=\"line\" data-line=\"22\" class=\"line\"></span>\n<span class=\"line\" data-line=\"23\" class=\"line\"><span style=\"color:#6A737D;--shiki-dark:#6A737D\">    # Steps represent a sequence of tasks that will be executed as part of the job</span></span>\n<span class=\"line\" data-line=\"24\" class=\"line\"><span style=\"color:#22863A;--shiki-dark:#85E89D\">    steps</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">:</span></span>\n<span class=\"line\" data-line=\"25\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">      - </span><span style=\"color:#22863A;--shiki-dark:#85E89D\">name</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">: </span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">Checkout Codes</span></span>\n<span class=\"line\" data-line=\"26\" class=\"line\"><span style=\"color:#22863A;--shiki-dark:#85E89D\">        uses</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">: </span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">actions/checkout@v3</span></span>\n<span class=\"line\" data-line=\"27\" class=\"line\"></span>\n<span class=\"line\" data-line=\"28\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">      - </span><span style=\"color:#22863A;--shiki-dark:#85E89D\">name</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">: </span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">Restart MX Service</span></span>\n<span class=\"line\" data-line=\"29\" class=\"line\"><span style=\"color:#22863A;--shiki-dark:#85E89D\">        uses</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">: </span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">garygrossgarten/github-action-ssh@release</span></span>\n<span class=\"line\" data-line=\"30\" class=\"line\"><span style=\"color:#22863A;--shiki-dark:#85E89D\">        with</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">:</span></span>\n<span class=\"line\" data-line=\"31\" class=\"line\"><span style=\"color:#22863A;--shiki-dark:#85E89D\">          command</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">: </span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">./restart.sh</span></span>\n<span class=\"line\" data-line=\"32\" class=\"line\"><span style=\"color:#22863A;--shiki-dark:#85E89D\">          host</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">: </span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">${{ secrets.HOST }}</span></span>\n<span class=\"line\" data-line=\"33\" class=\"line\"><span style=\"color:#22863A;--shiki-dark:#85E89D\">          username</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">: </span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">root</span></span>\n<span class=\"line\" data-line=\"34\" class=\"line\"><span style=\"color:#22863A;--shiki-dark:#85E89D\">          password</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">: </span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">${{ secrets.PASSWORD }}</span></span>\n<span class=\"line\" data-line=\"35\" class=\"line\"></span>\n<span class=\"line\" data-line=\"36\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">      - </span><span style=\"color:#22863A;--shiki-dark:#85E89D\">name</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">: </span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">Finish</span></span>\n<span class=\"line\" data-line=\"37\" class=\"line\"><span style=\"color:#22863A;--shiki-dark:#85E89D\">        run</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">: </span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">echo \"Action Finish\"</span></span>\n<span class=\"line\" data-line=\"38\" class=\"line\"></span></code></pre>\n        </div>\n<p>SSH相关配置自行查看<a href=\"https://github.com/marketplace/actions/run-ssh-command\">官方文档</a>，<code>restart.sh</code>内容填写重启docker指令即可。</p>\n<p>可参考以下内容：</p>\n<div class=\"code-block-wrapper\">\n          <div class=\"code-block-header\">\n            <span class=\"code-lang\">SHELL</span>\n            <div class=\"copy-card\" onclick=\"window.copyToClipboard(this)\">Copy</div>\n          </div>\n          <pre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\" data-line=\"1\" class=\"line\"><span style=\"color:#6A737D;--shiki-dark:#6A737D\">#!/bin/bash</span></span>\n<span class=\"line\" data-line=\"2\" class=\"line\"><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">cd</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> /mailu</span></span>\n<span class=\"line\" data-line=\"3\" class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">docker-compose</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> down</span></span>\n<span class=\"line\" data-line=\"4\" class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">docker-compose</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> up</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> -d</span></span>\n<span class=\"line\" data-line=\"5\" class=\"line\"></span></code></pre>\n        </div>\n<p>保存，然后去设置Secret：</p>\n<p><img loading=\"lazy\" src=\"https://img.ordchaos.com/img/2024/02/265d26f043a2d554f2fe8a74ad1b1e36.png\" alt=\"\"></p>\n<p>分别设置服务器地址、密码等即可：</p>\n<p><img loading=\"lazy\" src=\"https://img.ordchaos.com/img/2024/02/dfc32309634675e5cb5269692da37c13.png\" alt=\"\"></p>\n<p>大功告成！</p>\n<h2 id=\"6db6abec\">结语</h2>\n<p>上高中之后就没写博文了……</p>\n<p>除夕赶出一篇博文，祝新年快乐！！！</p>\n<p>也迟来的祝博客两周年快乐！！！</p>\n<h2 id=\"575432b1\">2024.2.12 更新</h2>\n<p>经评论<a href=\"https://alampy.com/\">@极地萤火(橙子)</a>提醒，增加自动推送commit同时记录log功能。</p>\n<p>首先，进入仓库设置：</p>\n<p><img loading=\"lazy\" src=\"https://img.ordchaos.com/img/2024/02/c4c3600448c97ba96934e025554e40d9.png\" alt=\"\"></p>\n<p>选择Action选项卡：</p>\n<p><img loading=\"lazy\" src=\"https://img.ordchaos.com/img/2024/02/6dd35d54352e8f341f6d4f21e076f78a.png\" alt=\"\"></p>\n<p>修改访问权限为读写：</p>\n<p><img loading=\"lazy\" src=\"https://img.ordchaos.com/img/2024/02/9eef169d5e8f617e4f61b2da73185d6d.png\" alt=\"\"></p>\n<p>保存即可。</p>\n<p>然后，修改Action内容，增加推流部分：</p>\n<div class=\"code-block-wrapper\">\n          <div class=\"code-block-header\">\n            <span class=\"code-lang\">YAML</span>\n            <div class=\"copy-card\" onclick=\"window.copyToClipboard(this)\">Copy</div>\n          </div>\n          <pre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\" data-line=\"1\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">- </span><span style=\"color:#22863A;--shiki-dark:#85E89D\">name</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">: </span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">Update log.txt</span></span>\n<span class=\"line\" data-line=\"2\" class=\"line\"><span style=\"color:#22863A;--shiki-dark:#85E89D\">  run</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">: </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">|</span></span>\n<span class=\"line\" data-line=\"3\" class=\"line\"><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">    var=`date +%Y%m%d%H%M`</span></span>\n<span class=\"line\" data-line=\"4\" class=\"line\"><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">    echo $var | tee -a log.txt</span></span>\n<span class=\"line\" data-line=\"5\" class=\"line\"></span>\n<span class=\"line\" data-line=\"6\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">- </span><span style=\"color:#22863A;--shiki-dark:#85E89D\">name</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">: </span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">Commit</span></span>\n<span class=\"line\" data-line=\"7\" class=\"line\"><span style=\"color:#22863A;--shiki-dark:#85E89D\">  run</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">: </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">|</span></span>\n<span class=\"line\" data-line=\"8\" class=\"line\"><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">    git config --global user.name 'username'</span></span>\n<span class=\"line\" data-line=\"9\" class=\"line\"><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">    git config --global user.email 'youremail@example.com'</span></span>\n<span class=\"line\" data-line=\"10\" class=\"line\"><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">    git add log.txt</span></span>\n<span class=\"line\" data-line=\"11\" class=\"line\"><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">    var=`date +%Y%m%d%H%M`</span></span>\n<span class=\"line\" data-line=\"12\" class=\"line\"><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">    git commit -m $var</span></span>\n<span class=\"line\" data-line=\"13\" class=\"line\"><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">    git push origin main</span></span>\n<span class=\"line\" data-line=\"14\" class=\"line\"></span></code></pre>\n        </div>\n<p>记得将信息改为自己的github用户名与邮箱。</p>\n",
  "date": "2024-02-09 18:52:38",
  "excerpt": "主要是邮件服务器的容器经常崩溃，所以尝试设置定时任务来解决这个问题。",
  "readTime": "5",
  "summary": "这篇博文介绍了博主为解决邮件服务器容器频繁崩溃的问题，利用GitHub Actions设置定时任务，通过SSH远程执行脚本重启邮件服务，并结合Secret存储敏感信息以实现自动化运维的过程。",
  "tags": [
    "白嫖",
    "计算机",
    "编程",
    "教程"
  ],
  "title": "使用Github Action定时重启邮件服务",
  "toc": [
    {
      "id": "1afcb3cc",
      "level": 2,
      "text": "情景引入"
    },
    {
      "id": "dc64ae4b",
      "level": 2,
      "text": "设置 Action"
    },
    {
      "id": "6db6abec",
      "level": 2,
      "text": "结语"
    },
    {
      "id": "575432b1",
      "level": 2,
      "text": "2024.2.12 更新"
    }
  ],
  "updated": "2024-02-12 21:27:30"
}