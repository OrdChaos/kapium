# Nginx Kapium 静态资源配置示例
# 用于优化地提供 SPA 应用和静态资源

# AI 生成的，我留着备用

server {
    # 监听端口
    listen 80;
    listen [::]:80;
    
    # 如果使用 HTTPS（推荐）
    # listen 443 ssl http2;
    # listen [::]:443 ssl http2;
    # ssl_certificate /path/to/cert.pem;
    # ssl_certificate_key /path/to/key.pem;
    # ssl_protocols TLSv1.2 TLSv1.3;
    # ssl_ciphers HIGH:!aNULL:!MD5;
    
    # 为非 HTTPS 请求重定向到 HTTPS
    # if ($scheme != "https") {
    #     return 301 https://$server_name$request_uri;
    # }
    
    server_name example.com www.example.com;
    
    # root 指向构建输出目录
    root /path/to/kapium/build/dist;
    
    # 索引文件顺序
    index index.html;
    
    # ==================== 安全头 ====================
    
    # 防止 Clickjacking
    add_header X-Frame-Options "SAMEORIGIN" always;
    
    # 防止 MIME 类型嗅探
    add_header X-Content-Type-Options "nosniff" always;
    
    # 启用 XSS 保护
    add_header X-XSS-Protection "1; mode=block" always;
    
    # 内容安全策略
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com data:; img-src 'self' https: data:; connect-src 'self' https:;" always;
    
    # Referrer Policy
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # 权限策略
    add_header Permissions-Policy "camera=(), microphone=(), geolocation=(), payment=()" always;
    
    # ==================== 性能优化 ====================
    
    # 启用 gzip 压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types 
        text/plain
        text/css
        text/javascript
        application/javascript
        application/json
        application/xml
        image/svg+xml;
    gzip_comp_level 6;
    gzip_disable "msie6";
    
    # Brotli 压缩（如果编译了模块）
    # brotli on;
    # brotli_comp_level 6;
    # brotli_types
    #     text/plain
    #     text/css
    #     text/javascript
    #     application/javascript
    #     application/json
    #     image/svg+xml;
    
    # 启用预压缩文件（.gz 和 .br）
    # 如果文件的 .gz 版本存在，优先使用
    map $http_accept_encoding $compressed_suffix {
        default "";
        "~br" ".br";
        "~gzip" ".gz";
    }
    
    # 为压缩文件设置正确的类型
    types {
        text/html                             html htm;
        text/css                              css;
        application/javascript                js;
        application/json                      json;
        application/xml                       xml;
        image/svg+xml                         svg svgz;
        image/webp                            webp;
        image/png                             png;
        image/jpeg                            jpg jpeg;
        image/gif                             gif;
        image/x-icon                          ico;
        font/woff                             woff;
        font/woff2                            woff2;
        application/font-woff                 woff;
    }
    
    # ==================== 缓存策略 ====================
    
    # HTML 页面：不缓存或仅缓存短时间
    location ~ \.html?$ {
        add_header Cache-Control "public, max-age=3600, must-revalidate" always;
        add_header ETag $request_time;
        
        # 如果存在压缩版本，优先提供
        if (-f $request_filename$compressed_suffix) {
            rewrite ^(.*)$ $1$compressed_suffix break;
        }
        
        # 尝试提供压缩版本
        if ($http_accept_encoding ~ br) {
            rewrite ^(.*)$ $1.br break;
        }
        if ($http_accept_encoding ~ gzip) {
            rewrite ^(.*)$ $1.gz break;
        }
    }
    
    # 静态资源：长期缓存
    location ~ \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        add_header Cache-Control "public, max-age=31536000, immutable" always;
        add_header ETag $request_time;
        
        # 如果存在压缩版本，优先提供
        if (-f $request_filename$compressed_suffix) {
            rewrite ^(.*)$ $1$compressed_suffix break;
        }
    }
    
    # 数据文件：中期缓存
    location ~ \.(json|xml)$ {
        add_header Cache-Control "public, max-age=86400, must-revalidate" always;
        
        if (-f $request_filename$compressed_suffix) {
            rewrite ^(.*)$ $1$compressed_suffix break;
        }
    }
    
    # Sitemap 和 Robots：较短缓存
    location ~ /(sitemap\.xml|robots\.txt)$ {
        add_header Cache-Control "public, max-age=604800" always;
    }
    
    # RSS Feed：较短缓存
    location ~ \.xml$ {
        add_header Cache-Control "public, max-age=3600" always;
        add_header Content-Type "application/rss+xml" always;
    }
    
    # ==================== 单页应用路由 ====================
    
    # 对于非文件请求，尝试提供 index.html
    # 这允许客户端路由工作
    location / {
        # 存在文件或目录则直接提供
        if (-e $request_filename) {
            break;
        }
        
        # 否则重定向到根 index.html
        # vite-ssg 会预生成所需的 HTML 文件
        rewrite ^(.*)$ / break;
        
        # 或者，如果使用完全的 SSR，可以以下方式处理
        # rewrite ^/(.*)$ /index.html last;
    }
    
    # ==================== 特殊处理 ====================
    
    # Service Worker：不缓存
    location = /serviceWorker.js {
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
    }
    
    # Manifest 文件：短期缓存
    location = /manifest.json {
        add_header Cache-Control "public, max-age=3600" always;
    }
    
    # ==================== 日志 ====================
    
    access_log /var/log/nginx/kapium.access.log combined buffer=32k flush=1m;
    error_log /var/log/nginx/kapium.error.log warn;
    
    # ==================== 其他配置 ====================
    
    # 隐藏 Nginx 版本
    server_tokens off;
    
    # 启用连接复用
    keepalive_timeout 65;
    
    # 关闭不需要的 HTTP 方法
    if ($request_method !~ ^(GET|HEAD|POST|PUT|DELETE|OPTIONS)$) {
        return 405;
    }
}

# HTTP 到 HTTPS 重定向
server {
    listen 80;
    listen [::]:80;
    server_name example.com www.example.com;
    
    # 重定向所有 HTTP 请求到 HTTPS
    return 301 https://$server_name$request_uri;
}
