{
  "abbrlink": "23e22de2",
  "category": "教程",
  "content": "<p>原本博客用的都是普通图片，就算有懒加载，一堆圈圈一起转也惹人心烦。现在改为了原图/webp的自适应切换，效果好上不少。</p>\n<!--more-->\n<h2 id=\"3b4893fd\">前期准备</h2>\n<p>首要任务是拿到webp格式的图片，这个看自己。像我用的vps上的<a href=\"https://www.lsky.pro/\">Lsky Pro</a>，本地存储。有高性能vps可以试试用<a href=\"https://webp.sh\">Webp-Server</a>配合。但我的轻量应用承受不起，遂作罢。改为了定时shell脚本，一分钟触发一次：</p>\n<div class=\"code-block-wrapper\">\n          <div class=\"code-block-header\">\n            <span class=\"code-lang\">SHELL</span>\n            <div class=\"copy-card\" onclick=\"window.copyToClipboard(this)\">Copy</div>\n          </div>\n          <pre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\" data-line=\"1\" class=\"line\"><span style=\"color:#6A737D;--shiki-dark:#6A737D\">#!/bin/bash</span></span>\n<span class=\"line\" data-line=\"2\" class=\"line\"></span>\n<span class=\"line\" data-line=\"3\" class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">find</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> .</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> -type</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> f</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> -iname</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \"*.png\"</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> |</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> while</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> read</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> file</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">; </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">do</span></span>\n<span class=\"line\" data-line=\"4\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    if</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> [ </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">!</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> -f</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \"${</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">file</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">%</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">.</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">*</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">}.webp\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> ]; </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">then</span></span>\n<span class=\"line\" data-line=\"5\" class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">        cwebp</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> -q</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> 85</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">$file</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> -o</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \"${</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">file</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">%</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">.</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">*</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">}.webp\"</span></span>\n<span class=\"line\" data-line=\"6\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    fi</span></span>\n<span class=\"line\" data-line=\"7\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">done</span></span>\n<span class=\"line\" data-line=\"8\" class=\"line\"></span>\n<span class=\"line\" data-line=\"9\" class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">find</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> .</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> -type</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> f</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> -iname</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \"*.jpg\"</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> |</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> while</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> read</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> file</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">; </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">do</span></span>\n<span class=\"line\" data-line=\"10\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    if</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> [ </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">!</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> -f</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \"${</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">file</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">%</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">.</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">*</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">}.webp\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> ]; </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">then</span></span>\n<span class=\"line\" data-line=\"11\" class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">        cwebp</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> -q</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> 85</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">$file</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> -o</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \"${</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">file</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">%</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">.</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">*</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">}.webp\"</span></span>\n<span class=\"line\" data-line=\"12\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    fi</span></span>\n<span class=\"line\" data-line=\"13\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">done</span></span>\n<span class=\"line\" data-line=\"14\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    </span></span>\n<span class=\"line\" data-line=\"15\" class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">find</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> .</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> -type</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> f</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> -iname</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \"*.jpeg\"</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> |</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> while</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> read</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> file</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">; </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">do</span></span>\n<span class=\"line\" data-line=\"16\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    if</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> [ </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">!</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> -f</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \"${</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">file</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">%</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">.</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">*</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">}.webp\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> ]; </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">then</span></span>\n<span class=\"line\" data-line=\"17\" class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">        cwebp</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> -q</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> 85</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">$file</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> -o</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \"${</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">file</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">%</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">.</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">*</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">}.webp\"</span></span>\n<span class=\"line\" data-line=\"18\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    fi</span></span>\n<span class=\"line\" data-line=\"19\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">done</span></span>\n<span class=\"line\" data-line=\"20\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    </span></span>\n<span class=\"line\" data-line=\"21\" class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">find</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> .</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> -type</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> f</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> -iname</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \"*.tif\"</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> |</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> while</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> read</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> file</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">; </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">do</span></span>\n<span class=\"line\" data-line=\"22\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    if</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> [ </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">!</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> -f</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \"${</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">file</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">%</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">.</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">*</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">}.webp\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> ]; </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">then</span></span>\n<span class=\"line\" data-line=\"23\" class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">        cwebp</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> -q</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> 85</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">$file</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> -o</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \"${</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">file</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">%</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">.</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">*</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">}.webp\"</span></span>\n<span class=\"line\" data-line=\"24\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    fi</span></span>\n<span class=\"line\" data-line=\"25\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">done</span></span>\n<span class=\"line\" data-line=\"26\" class=\"line\"></span></code></pre>\n        </div>\n<p>脚本运行时会遍历自己所在的文件夹及其子文件夹，转换所有没有对应webp格式的图片（<code>png</code>，<code>jpg</code>、<code>jpeg</code>与<code>tiff</code>）为webp图片（原图还在，放心）。</p>\n<p>这段脚本中使用了<code>cwebp</code>指令，它来源于<code>libwebp</code>。安装可以参考下方：</p>\n<div class=\"code-block-wrapper\">\n          <div class=\"code-block-header\">\n            <span class=\"code-lang\">SHELL</span>\n            <div class=\"copy-card\" onclick=\"window.copyToClipboard(this)\">Copy</div>\n          </div>\n          <pre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\" data-line=\"1\" class=\"line\"><span style=\"color:#6A737D;--shiki-dark:#6A737D\"># 安装编译器以及依赖包</span></span>\n<span class=\"line\" data-line=\"2\" class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">yum</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> install</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> -y</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> gcc</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> make</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> autoconf</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> automake</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> libtool</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> libjpeg-devel</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> libpng-devel</span></span>\n<span class=\"line\" data-line=\"3\" class=\"line\"><span style=\"color:#6A737D;--shiki-dark:#6A737D\"># 请到官网下载最新版本，版本列表：https://storage.googleapis.com/downloads.webmproject.org/releases/webp/</span></span>\n<span class=\"line\" data-line=\"4\" class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">wget</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> https://storage.googleapis.com/downloads.webmproject.org/releases/webp/libwebp-1.2.4.tar.gz</span></span>\n<span class=\"line\" data-line=\"5\" class=\"line\"><span style=\"color:#6A737D;--shiki-dark:#6A737D\"># 解压</span></span>\n<span class=\"line\" data-line=\"6\" class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">tar</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> -zxvf</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> libwebp-1.2.4.tar.gz</span></span>\n<span class=\"line\" data-line=\"7\" class=\"line\"><span style=\"color:#6A737D;--shiki-dark:#6A737D\"># 进入目录</span></span>\n<span class=\"line\" data-line=\"8\" class=\"line\"><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">cd</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> libwebp-1.2.4</span></span>\n<span class=\"line\" data-line=\"9\" class=\"line\"><span style=\"color:#6A737D;--shiki-dark:#6A737D\"># 源代码安装环境检查</span></span>\n<span class=\"line\" data-line=\"10\" class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">./configure</span></span>\n<span class=\"line\" data-line=\"11\" class=\"line\"><span style=\"color:#6A737D;--shiki-dark:#6A737D\"># 编译</span></span>\n<span class=\"line\" data-line=\"12\" class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">make</span></span>\n<span class=\"line\" data-line=\"13\" class=\"line\"><span style=\"color:#6A737D;--shiki-dark:#6A737D\"># 安装</span></span>\n<span class=\"line\" data-line=\"14\" class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">make</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> install</span></span>\n<span class=\"line\" data-line=\"15\" class=\"line\"></span></code></pre>\n        </div>\n<p>安装过程中遇到问题请善用百度/Google，本人不对此负责（bushi</p>\n<p>做好以上所有工作后，就可以开始下面的内容。</p>\n<h2 id=\"bd119ff2\">Service Worker</h2>\n<h3 id=\"264baeff\">安装</h3>\n<p>不知道是什么、如何部署的，可以看看CYF大佬的这两篇文章：</p>\n<ul>\n<li><a href=\"https://blog.eurekac.cn/p/c0af86bb.html\">欲善其事，必利其器 - 论如何善用ServiceWorker</a></li>\n<li><a href=\"https://blog.eurekac.cn/p/d3c51290.html\">SpeedUp!使用黑科技为你的网站提速</a></li>\n</ul>\n<p>如果你已经部署了Service Worker就可以继续了。</p>\n<h3 id=\"3b895c6d\">脚本</h3>\n<p>添加一个监听器，监听<code>fetch</code>事件：</p>\n<div class=\"code-block-wrapper\">\n          <div class=\"code-block-header\">\n            <span class=\"code-lang\">JAVASCRIPT</span>\n            <div class=\"copy-card\" onclick=\"window.copyToClipboard(this)\">Copy</div>\n          </div>\n          <pre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\" data-line=\"1\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">self.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">addEventListener</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">'fetch'</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">, </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">async</span><span style=\"color:#E36209;--shiki-dark:#FFAB70\"> event</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> =></span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> {</span></span>\n<span class=\"line\" data-line=\"2\" class=\"line\"><span style=\"color:#6A737D;--shiki-dark:#6A737D\">    //...</span></span>\n<span class=\"line\" data-line=\"3\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">});</span></span>\n<span class=\"line\" data-line=\"4\" class=\"line\"></span></code></pre>\n        </div>\n<p>（或者在本来的监听器里面加上）</p>\n<p>然后判断流量是否是对图站的请求，可以用一个if来判断：</p>\n<div class=\"code-block-wrapper\">\n          <div class=\"code-block-header\">\n            <span class=\"code-lang\">JAVASCRIPT</span>\n            <div class=\"copy-card\" onclick=\"window.copyToClipboard(this)\">Copy</div>\n          </div>\n          <pre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\" data-line=\"1\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">if</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(event.request.url.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">indexOf</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">'your.image.site'</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">) </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">!==</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> -</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">1</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">) {</span></span>\n<span class=\"line\" data-line=\"2\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    var</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> requestUrl </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> event.request.url;</span></span>\n<span class=\"line\" data-line=\"3\" class=\"line\"><span style=\"color:#6A737D;--shiki-dark:#6A737D\">    //...</span></span>\n<span class=\"line\" data-line=\"4\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">}</span></span>\n<span class=\"line\" data-line=\"5\" class=\"line\"></span></code></pre>\n        </div>\n<p><code>event.request.url</code>是请求的地址，用<code>indexOf()</code>方法来判断地址中是否包含图站地址，若不反回代表没有的-1即为是对图站的请求。</p>\n<p>接下来判断浏览器是否支持webp图片，定义一个变量<code>supportsWebp</code></p>\n<div class=\"code-block-wrapper\">\n          <div class=\"code-block-header\">\n            <span class=\"code-lang\">JAVASCRIPT</span>\n            <div class=\"copy-card\" onclick=\"window.copyToClipboard(this)\">Copy</div>\n          </div>\n          <pre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\" data-line=\"1\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">var</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> supportsWebp </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> false</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">;</span></span>\n<span class=\"line\" data-line=\"2\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">if</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> (event.request.headers.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">has</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">'accept'</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">)){</span></span>\n<span class=\"line\" data-line=\"3\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    supportsWebp </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> event.request.headers</span></span>\n<span class=\"line\" data-line=\"4\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">            .</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">get</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">'accept'</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">)</span></span>\n<span class=\"line\" data-line=\"5\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">            .</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">includes</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">'webp'</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">);</span></span>\n<span class=\"line\" data-line=\"6\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">}</span></span>\n<span class=\"line\" data-line=\"7\" class=\"line\"></span></code></pre>\n        </div>\n<p>如果可以获取到浏览器的Accept头，且头中包含<code>image/webp</code>，即为支持webp，否则为不支持。</p>\n<p>然后就可以进一步处理了，若浏览器支持webp，则进行下一步：</p>\n<div class=\"code-block-wrapper\">\n          <div class=\"code-block-header\">\n            <span class=\"code-lang\">JAVASCRIPT</span>\n            <div class=\"copy-card\" onclick=\"window.copyToClipboard(this)\">Copy</div>\n          </div>\n          <pre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\" data-line=\"1\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">if</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> (supportsWebp) {</span></span>\n<span class=\"line\" data-line=\"2\" class=\"line\"><span style=\"color:#6A737D;--shiki-dark:#6A737D\">    //...</span></span>\n<span class=\"line\" data-line=\"3\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">}</span></span>\n<span class=\"line\" data-line=\"4\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">else</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> {</span></span>\n<span class=\"line\" data-line=\"5\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    console.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">log</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"[SW] Don't support webp image, skip \"</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> +</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> requestUrl </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">+</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \" .\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">);</span></span>\n<span class=\"line\" data-line=\"6\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">}</span></span>\n<span class=\"line\" data-line=\"7\" class=\"line\"></span></code></pre>\n        </div>\n<p>然后获取请求的文件类型。最开始的脚本只支持<code>png</code>，<code>jpg</code>、<code>jpeg</code>与<code>tiff</code>这四种格式的图片，所以我们也只能篡改这四种格式图片的请求到webp图片上：</p>\n<div class=\"code-block-wrapper\">\n          <div class=\"code-block-header\">\n            <span class=\"code-lang\">JAVASCRIPT</span>\n            <div class=\"copy-card\" onclick=\"window.copyToClipboard(this)\">Copy</div>\n          </div>\n          <pre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\" data-line=\"1\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">var</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> imageUrl </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> requestUrl.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">split</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\".\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">);</span></span>\n<span class=\"line\" data-line=\"2\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">if</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(imageUrl[imageUrl.</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">length</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> -</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> 1</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">] </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">===</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> 'jpg'</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> ||</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> imageUrl[imageUrl.</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">length</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> -</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> 1</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">] </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">===</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> 'tif'</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> ||</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> imageUrl[imageUrl.</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">length</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> -</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> 1</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">] </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">===</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> 'png'</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> ||</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> imageUrl[imageUrl.</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">length</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> -</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> 1</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">] </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">===</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> 'jpeg'</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">) {</span></span>\n<span class=\"line\" data-line=\"3\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    var</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> newUrl </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> requestUrl.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">replace</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(imageUrl[imageUrl.</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">length</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> -</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> 1</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">], </span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">'webp'</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">);</span></span>\n<span class=\"line\" data-line=\"4\" class=\"line\"><span style=\"color:#6A737D;--shiki-dark:#6A737D\">    //...</span></span>\n<span class=\"line\" data-line=\"5\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">}</span></span>\n<span class=\"line\" data-line=\"6\" class=\"line\"></span></code></pre>\n        </div>\n<p><code>newUrl</code>中存储了新的请求地址，接下来对它发起请求即可：</p>\n<div class=\"code-block-wrapper\">\n          <div class=\"code-block-header\">\n            <span class=\"code-lang\">JAVASCRIPT</span>\n            <div class=\"copy-card\" onclick=\"window.copyToClipboard(this)\">Copy</div>\n          </div>\n          <pre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\" data-line=\"1\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">var</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> newRequest </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> new</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> Request</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(newUrl);</span></span>\n<span class=\"line\" data-line=\"2\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">event.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">respondWith</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">fetch</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(newRequest));</span></span>\n<span class=\"line\" data-line=\"3\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">console.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">log</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"[SW] Redirect \"</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> +</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> requestUrl </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">+</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \" to \"</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> +</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> newUrl </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">+</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \" .\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">);</span></span>\n<span class=\"line\" data-line=\"4\" class=\"line\"></span></code></pre>\n        </div>\n<p>当请求完成并图片被完整下载以后，进行缓存，代码如下：</p>\n<div class=\"code-block-wrapper\">\n          <div class=\"code-block-header\">\n            <span class=\"code-lang\">JAVASCRIPT</span>\n            <div class=\"copy-card\" onclick=\"window.copyToClipboard(this)\">Copy</div>\n          </div>\n          <pre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\" data-line=\"1\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">event.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">waitUntil</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span></span>\n<span class=\"line\" data-line=\"2\" class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">    fetch</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(newRequest).</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">then</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">function</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#E36209;--shiki-dark:#FFAB70\">response</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">) {</span></span>\n<span class=\"line\" data-line=\"3\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">        if</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> (</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">!</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">response.ok) </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">throw</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> new</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> Error</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"[SW] Failed to load image: \"</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> +</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> newUrl);</span></span>\n<span class=\"line\" data-line=\"4\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">            caches.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">open</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">CACHE_NAME</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">).</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">then</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">function</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#E36209;--shiki-dark:#FFAB70\">cache</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">) {</span></span>\n<span class=\"line\" data-line=\"5\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">                cache.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">put</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(newRequest, response);</span></span>\n<span class=\"line\" data-line=\"6\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">            });</span></span>\n<span class=\"line\" data-line=\"7\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    }).</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">catch</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">function</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#E36209;--shiki-dark:#FFAB70\">error</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">) {</span></span>\n<span class=\"line\" data-line=\"8\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">        console.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">log</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(error);</span></span>\n<span class=\"line\" data-line=\"9\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    })</span></span>\n<span class=\"line\" data-line=\"10\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">);</span></span>\n<span class=\"line\" data-line=\"11\" class=\"line\"></span></code></pre>\n        </div>\n<p>若获取失败则提示，成功则缓存。</p>\n<p>最后，要打断之前的请求，避免降低速度，可以调用<code>event.stopImmediatePropagation()</code>方法打断原始请求。</p>\n<p>最后完整代码如下：</p>\n<div class=\"code-block-wrapper\">\n          <div class=\"code-block-header\">\n            <span class=\"code-lang\">JAVASCRIPT</span>\n            <div class=\"copy-card\" onclick=\"window.copyToClipboard(this)\">Copy</div>\n          </div>\n          <pre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\" data-line=\"1\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">if</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(event.request.url.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">indexOf</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">'img.ordchaos.com'</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">) </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">!==</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> -</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">1</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">) {</span></span>\n<span class=\"line\" data-line=\"2\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    var</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> requestUrl </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> event.request.url;</span></span>\n<span class=\"line\" data-line=\"3\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    var</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> supportsWebp </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> false</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">;</span></span>\n<span class=\"line\" data-line=\"4\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    if</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> (event.request.headers.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">has</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">'accept'</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">)){</span></span>\n<span class=\"line\" data-line=\"5\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">        supportsWebp </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> event.request.headers</span></span>\n<span class=\"line\" data-line=\"6\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">                            .</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">get</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">'accept'</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">)</span></span>\n<span class=\"line\" data-line=\"7\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">                            .</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">includes</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">'webp'</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">);</span></span>\n<span class=\"line\" data-line=\"8\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    }</span></span>\n<span class=\"line\" data-line=\"9\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    if</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> (supportsWebp) {</span></span>\n<span class=\"line\" data-line=\"10\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">        var</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> imageUrl </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> requestUrl.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">split</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\".\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">);</span></span>\n<span class=\"line\" data-line=\"11\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">        if</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(imageUrl[imageUrl.</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">length</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> -</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> 1</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">] </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">===</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> 'jpg'</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> ||</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> imageUrl[imageUrl.</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">length</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> -</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> 1</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">] </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">===</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> 'tif'</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> ||</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> imageUrl[imageUrl.</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">length</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> -</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> 1</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">] </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">===</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> 'png'</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> ||</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> imageUrl[imageUrl.</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">length</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> -</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> 1</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">] </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">===</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> 'jpeg'</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">){</span></span>\n<span class=\"line\" data-line=\"12\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">            var</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> newUrl </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> requestUrl.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">replace</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(imageUrl[imageUrl.</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">length</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> -</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> 1</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">], </span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">'webp'</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">);</span></span>\n<span class=\"line\" data-line=\"13\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">            var</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> newRequest </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> new</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> Request</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(newUrl);</span></span>\n<span class=\"line\" data-line=\"14\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">            event.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">respondWith</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">fetch</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(newRequest));</span></span>\n<span class=\"line\" data-line=\"15\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">            console.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">log</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"[SW] Redirect \"</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> +</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> requestUrl </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">+</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \" to \"</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> +</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> newUrl </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">+</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \" .\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">);</span></span>\n<span class=\"line\" data-line=\"16\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">            event.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">waitUntil</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span></span>\n<span class=\"line\" data-line=\"17\" class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">                fetch</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(newRequest).</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">then</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">function</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#E36209;--shiki-dark:#FFAB70\">response</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">) {</span></span>\n<span class=\"line\" data-line=\"18\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">                    if</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> (</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">!</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">response.ok) </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">throw</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> new</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> Error</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"[SW] Failed to load image: \"</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> +</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> newUrl);</span></span>\n<span class=\"line\" data-line=\"19\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">                    caches.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">open</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">CACHE_NAME</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">).</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">then</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">function</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#E36209;--shiki-dark:#FFAB70\">cache</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">) {</span></span>\n<span class=\"line\" data-line=\"20\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">                        cache.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">put</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(newRequest, response);</span></span>\n<span class=\"line\" data-line=\"21\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">                    });</span></span>\n<span class=\"line\" data-line=\"22\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">                }).</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">catch</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">function</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#E36209;--shiki-dark:#FFAB70\">error</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">) {</span></span>\n<span class=\"line\" data-line=\"23\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">                    console.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">log</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(error);</span></span>\n<span class=\"line\" data-line=\"24\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">                })</span></span>\n<span class=\"line\" data-line=\"25\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">            );</span></span>\n<span class=\"line\" data-line=\"26\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">            event.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">stopImmediatePropagation</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">();</span></span>\n<span class=\"line\" data-line=\"27\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">            return</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">;</span></span>\n<span class=\"line\" data-line=\"28\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">        }</span></span>\n<span class=\"line\" data-line=\"29\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    }</span></span>\n<span class=\"line\" data-line=\"30\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    else</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> {</span></span>\n<span class=\"line\" data-line=\"31\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">        console.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">log</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"[SW] Don't support webp image, skip \"</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> +</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> requestUrl </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">+</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \" .\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">);</span></span>\n<span class=\"line\" data-line=\"32\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    }</span></span>\n<span class=\"line\" data-line=\"33\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">}</span></span>\n<span class=\"line\" data-line=\"34\" class=\"line\"></span></code></pre>\n        </div>\n<p>你学会了吗？</p>\n<h2 id=\"54662b2f\">测试</h2>\n<p>进入网站，若一切正常，当加载到一张图片时，控制台（<code>F12</code>打开）会提示<code>[SW] Redirect https://your.image.site/path/to/img.png to https://your.image.site/path/to/img.webp .</code>这样的信息。</p>\n<p>要测试无webp支持的情景，则点击右上角的三个点。</p>\n<p><img loading=\"lazy\" src=\"https://img.ordchaos.com/img/2023/01/01562686a8db1bb30defe61ffa333bd1.png\" alt=\"\"></p>\n<p><img loading=\"lazy\" src=\"https://img.ordchaos.com/img/2023/01/372ab8df519f78c5d59ea93fcd4caf78.png\" alt=\"\"></p>\n<p>选择更多工具，找到“渲染”并点击。</p>\n<p><img loading=\"lazy\" src=\"https://img.ordchaos.com/img/2023/01/6a65c870cbafb3f9f5743d96749c549a.png\" alt=\"\"></p>\n<p>勾选“停用webp”即可。</p>\n<p>此时，加载图片时会提示<code>[SW] Don't support webp image, skip https://your.image.site/path/to/img.png .</code></p>\n<p>可以试试我这里的这张图片：（图片来自CYF大佬的<code>Client Worker</code>项目的文档）</p>\n<p><img loading=\"lazy\" src=\"https://img.ordchaos.com/img/2023/01/9f2975321779cda14980431c4595bb37.jpg\" alt=\"\"></p>\n<p>若浏览器支持webp则会显示<code>Webp Accept!</code>，否则为<code>Webp Reject!This is a jpg file.</code></p>\n<p><strong>(2024.08.03)</strong> 现在支持avif则会优先显示<code>Avif Accept!</code></p>\n<h2 id=\"f23d890d\">题外话</h2>\n<p>刚刚放寒假，舒坦。</p>\n<p>但与之对应，九上已经结束，还有一学期就中考。。。</p>\n<p>加油！我可以的！</p>\n<p>那就这样，886！</p>\n<h2 id=\"31bef84f\">2024.08.03 更新</h2>\n<p>看了Heo的<a href=\"https://blog.zhheo.com/p/6a933575.html\">实现全站图片使用avif格式，替代臃肿的webp教程</a>，好吧，再换一下。</p>\n<p>服务器上使用<code>cavif</code>工具转换图片格式，<code>service worker</code>上简单改一下就好。</p>\n<p>参考：</p>\n<p><code>img2webp.sh</code>内容：</p>\n<div class=\"code-block-wrapper\">\n          <div class=\"code-block-header\">\n            <span class=\"code-lang\">SHELL</span>\n            <div class=\"copy-card\" onclick=\"window.copyToClipboard(this)\">Copy</div>\n          </div>\n          <pre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\" data-line=\"1\" class=\"line\"><span style=\"color:#6A737D;--shiki-dark:#6A737D\">#!/bin/bash</span></span>\n<span class=\"line\" data-line=\"2\" class=\"line\"></span>\n<span class=\"line\" data-line=\"3\" class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">convert_to_formats</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">() {</span></span>\n<span class=\"line\" data-line=\"4\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    local</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> file</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">$1</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"</span></span>\n<span class=\"line\" data-line=\"5\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    local</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> base</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"${</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">file</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">%</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">.</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">*</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">}\"</span></span>\n<span class=\"line\" data-line=\"6\" class=\"line\"></span>\n<span class=\"line\" data-line=\"7\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    if</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> [ </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">!</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> -f</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \"${</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">base</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">}.webp\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> ]; </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">then</span></span>\n<span class=\"line\" data-line=\"8\" class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">        cwebp</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> -q</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> 85</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">$file</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> -o</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \"${</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">base</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">}.webp\"</span></span>\n<span class=\"line\" data-line=\"9\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    fi</span></span>\n<span class=\"line\" data-line=\"10\" class=\"line\"></span>\n<span class=\"line\" data-line=\"11\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    if</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> [ </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">!</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> -f</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \"${</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">base</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">}.avif\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> ]; </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">then</span></span>\n<span class=\"line\" data-line=\"12\" class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">        cavif</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> -Q</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> 80</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">$file</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> -o</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \"${</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">base</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">}.avif\"</span></span>\n<span class=\"line\" data-line=\"13\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    fi</span></span>\n<span class=\"line\" data-line=\"14\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">}</span></span>\n<span class=\"line\" data-line=\"15\" class=\"line\"></span>\n<span class=\"line\" data-line=\"16\" class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">find</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> .</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> -type</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> f</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> -iname</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \"*.png\"</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> |</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> while</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> read</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> file</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">; </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">do</span></span>\n<span class=\"line\" data-line=\"17\" class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">    convert_to_formats</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">$file</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"</span></span>\n<span class=\"line\" data-line=\"18\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">done</span></span>\n<span class=\"line\" data-line=\"19\" class=\"line\"></span>\n<span class=\"line\" data-line=\"20\" class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">find</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> .</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> -type</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> f</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> -iname</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \"*.jpg\"</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> |</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> while</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> read</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> file</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">; </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">do</span></span>\n<span class=\"line\" data-line=\"21\" class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">    convert_to_formats</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">$file</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"</span></span>\n<span class=\"line\" data-line=\"22\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">done</span></span>\n<span class=\"line\" data-line=\"23\" class=\"line\"></span>\n<span class=\"line\" data-line=\"24\" class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">find</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> .</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> -type</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> f</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> -iname</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \"*.jpeg\"</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> |</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> while</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> read</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> file</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">; </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">do</span></span>\n<span class=\"line\" data-line=\"25\" class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">    convert_to_formats</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">$file</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"</span></span>\n<span class=\"line\" data-line=\"26\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">done</span></span>\n<span class=\"line\" data-line=\"27\" class=\"line\"></span></code></pre>\n        </div>\n<p><code>sw.js</code>重定向段：</p>\n<div class=\"code-block-wrapper\">\n          <div class=\"code-block-header\">\n            <span class=\"code-lang\">JAVASCRIPT</span>\n            <div class=\"copy-card\" onclick=\"window.copyToClipboard(this)\">Copy</div>\n          </div>\n          <pre class=\"shiki shiki-themes github-light github-dark\" style=\"background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\" data-line=\"1\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">if</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> (event.request.url.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">indexOf</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">'img.ordchaos.com'</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">) </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">!==</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> -</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">1</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">) {</span></span>\n<span class=\"line\" data-line=\"2\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    var</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> supportsWebp </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> false</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">;</span></span>\n<span class=\"line\" data-line=\"3\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    var</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> supportsAvif </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> false</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">;</span></span>\n<span class=\"line\" data-line=\"4\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    if</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> (event.request.headers.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">has</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">'accept'</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">)) {</span></span>\n<span class=\"line\" data-line=\"5\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">        var</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> acceptHeader </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> event.request.headers.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">get</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">'accept'</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">);</span></span>\n<span class=\"line\" data-line=\"6\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">        supportsWebp </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> acceptHeader.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">includes</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">'webp'</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">);</span></span>\n<span class=\"line\" data-line=\"7\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">        supportsAvif </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> acceptHeader.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">includes</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">'avif'</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">);</span></span>\n<span class=\"line\" data-line=\"8\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    }</span></span>\n<span class=\"line\" data-line=\"9\" class=\"line\"></span>\n<span class=\"line\" data-line=\"10\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    var</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> imageUrl </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> requestUrl.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">split</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\".\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">);</span></span>\n<span class=\"line\" data-line=\"11\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    var</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> fileExtension </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> imageUrl[imageUrl.</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">length</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> -</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\"> 1</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">];</span></span>\n<span class=\"line\" data-line=\"12\" class=\"line\"></span>\n<span class=\"line\" data-line=\"13\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">    if</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> (fileExtension </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">===</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> 'jpg'</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> ||</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> fileExtension </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">===</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> 'png'</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> ||</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> fileExtension </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">===</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> 'jpeg'</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">) {</span></span>\n<span class=\"line\" data-line=\"14\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">        var</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> newUrl;</span></span>\n<span class=\"line\" data-line=\"15\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">        if</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> (supportsAvif) {</span></span>\n<span class=\"line\" data-line=\"16\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">            newUrl </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> requestUrl.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">replace</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(fileExtension, </span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">'avif'</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">);</span></span>\n<span class=\"line\" data-line=\"17\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">            console.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">log</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"[SW] Redirect \"</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> +</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> requestUrl </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">+</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \" to \"</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> +</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> newUrl </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">+</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \" (AVIF).\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">);</span></span>\n<span class=\"line\" data-line=\"18\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">        } </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">else</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> if</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> (supportsWebp) {</span></span>\n<span class=\"line\" data-line=\"19\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">            newUrl </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> requestUrl.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">replace</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(fileExtension, </span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">'webp'</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">);</span></span>\n<span class=\"line\" data-line=\"20\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">            console.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">log</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"[SW] Redirect \"</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> +</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> requestUrl </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">+</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \" to \"</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> +</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> newUrl </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">+</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \" (WebP).\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">);</span></span>\n<span class=\"line\" data-line=\"21\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">        } </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">else</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> {</span></span>\n<span class=\"line\" data-line=\"22\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">            console.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">log</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"[SW] Don't support AVIF or WebP, using original format for \"</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> +</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> requestUrl </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">+</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\"> \".\"</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">);</span></span>\n<span class=\"line\" data-line=\"23\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">            newUrl </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> requestUrl;</span></span>\n<span class=\"line\" data-line=\"24\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">        }</span></span>\n<span class=\"line\" data-line=\"25\" class=\"line\"></span>\n<span class=\"line\" data-line=\"26\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">        var</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> newRequest </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">=</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> new</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> Request</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(newUrl);</span></span>\n<span class=\"line\" data-line=\"27\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">        event.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">respondWith</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span></span>\n<span class=\"line\" data-line=\"28\" class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">            fetch</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(newRequest)</span></span>\n<span class=\"line\" data-line=\"29\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">                .</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">then</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">function</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> (</span><span style=\"color:#E36209;--shiki-dark:#FFAB70\">response</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">) {</span></span>\n<span class=\"line\" data-line=\"30\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">                    if</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> (</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">!</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">response.ok) </span><span style=\"color:#D73A49;--shiki-dark:#F97583\">throw</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> new</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> Error</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#032F62;--shiki-dark:#9ECBFF\">\"[SW] Failed to load image: \"</span><span style=\"color:#D73A49;--shiki-dark:#F97583\"> +</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> newUrl);</span></span>\n<span class=\"line\" data-line=\"31\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">                    return</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> caches.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">open</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#005CC5;--shiki-dark:#79B8FF\">CACHE_NAME</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">).</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">then</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">function</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> (</span><span style=\"color:#E36209;--shiki-dark:#FFAB70\">cache</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">) {</span></span>\n<span class=\"line\" data-line=\"32\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">                        cache.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">put</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(newRequest, response.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">clone</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">());</span></span>\n<span class=\"line\" data-line=\"33\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">                        return</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> response;</span></span>\n<span class=\"line\" data-line=\"34\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">                    });</span></span>\n<span class=\"line\" data-line=\"35\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">                })</span></span>\n<span class=\"line\" data-line=\"36\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">                .</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">catch</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(</span><span style=\"color:#D73A49;--shiki-dark:#F97583\">function</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\"> (</span><span style=\"color:#E36209;--shiki-dark:#FFAB70\">error</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">) {</span></span>\n<span class=\"line\" data-line=\"37\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">                    console.</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">log</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(error);</span></span>\n<span class=\"line\" data-line=\"38\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">                    return</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> fetch</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">(event.request);</span></span>\n<span class=\"line\" data-line=\"39\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">                })</span></span>\n<span class=\"line\" data-line=\"40\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">        );</span></span>\n<span class=\"line\" data-line=\"41\" class=\"line\"><span style=\"color:#D73A49;--shiki-dark:#F97583\">        return</span><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">;</span></span>\n<span class=\"line\" data-line=\"42\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">    }</span></span>\n<span class=\"line\" data-line=\"43\" class=\"line\"><span style=\"color:#24292E;--shiki-dark:#E1E4E8\">}</span></span>\n<span class=\"line\" data-line=\"44\" class=\"line\"></span></code></pre>\n        </div>\n",
  "date": "2023-01-12 09:42:10",
  "excerpt": "原本博客用的都是普通图片，就算有懒加载，一堆圈圈一起转也惹人心烦。现在改为了原图/webp的自适应切换，效果好上不少。",
  "readTime": "14",
  "summary": "这篇博文介绍了博主通过生成WebP格式图片并利用Service Worker实现原图与WebP的自适应切换，以提升博客图片加载性能的实践过程。",
  "tags": [
    "计算机",
    "编程",
    "优化",
    "教程"
  ],
  "title": "全站 webp 自动切换，加速访问好帮手",
  "toc": [
    {
      "id": "3b4893fd",
      "level": 2,
      "text": "前期准备"
    },
    {
      "id": "bd119ff2",
      "level": 2,
      "text": "Service Worker"
    },
    {
      "id": "264baeff",
      "level": 3,
      "text": "安装"
    },
    {
      "id": "3b895c6d",
      "level": 3,
      "text": "脚本"
    },
    {
      "id": "54662b2f",
      "level": 2,
      "text": "测试"
    },
    {
      "id": "f23d890d",
      "level": 2,
      "text": "题外话"
    },
    {
      "id": "31bef84f",
      "level": 2,
      "text": "2024.08.03 更新"
    }
  ],
  "update": "2024-08-03 17:45:10"
}